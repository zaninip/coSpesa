<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>CoSpesa · Lista</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      tailwind = {
        config: {
          theme: { extend: { colors: { brand: "#ffd54a", bg: "#0a0a0a" } } },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="bg-[var(--bg)] text-white">
    <header class="border-b border-[#1f1f1f]">
      <div class="container flex items-center justify-between py-4">
        <div class="flex items-center gap-3">
          <a href="dashboard.html"
            ><img src="assets/logo.svg" class="h-9" alt="CoSpesa"
          /></a>
          <span class="badge">Lista</span>
        </div>
        <button id="history" class="btn btn-secondary flex items-center gap-2">
          <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Storico
        </button>
      </div>
    </header>

    <main class="container space-y-5">
      <div class="card p-5 flex items-center justify-between">
        <div>
          <h1 id="shopping-title" class="text-2xl font-extrabold">
            Lista Spesa
          </h1>
          <p class="muted mt-1">
            Codice:
            <span id="shopping-code" class="text-[var(--brand)] font-bold"
              >-</span
            >
          </p>
        </div>
        <button id="copy-code" class="btn btn-primary flex items-center gap-2">
          <i data-lucide="copy" class="w-5 h-5"></i> Copia
        </button>
      </div>

      <section class="card p-5">
        <div class="grid md:grid-cols-[1fr_auto] gap-3">
          <input
            id="new-product"
            class="input w-full"
            placeholder="Aggiungi prodotto..."
          />
          <button
            id="add-product"
            class="btn btn-primary flex items-center justify-center gap-2"
          >
            <i data-lucide="plus" class="w-5 h-5"></i> Aggiungi
          </button>
        </div>

        <div class="mt-4 grid md:grid-cols-[1fr_auto_auto] gap-3 items-center">
          <div class="muted text-sm flex items-center gap-2">
            <i data-lucide="history" class="w-4 h-4"></i> Oppure scegli dallo
            storico:
          </div>
          <select id="history-select" class="input"></select>
          <button id="add-from-history" class="btn btn-secondary">
            Aggiungi
          </button>
        </div>
      </section>

      <section class="card p-5 fade-in">
        <h2 class="text-xl font-bold mb-3">Prodotti</h2>
        <ul id="products-list" class="space-y-3"></ul>
      </section>

      <div class="flex justify-end">
        <a href="dashboard.html" class="btn btn-secondary"
          >⬅ Torna alla Dashboard</a
        >
      </div>
    </main>

    <template id="tpl-product">
      <li class="li flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i data-lucide="circle" class="w-4 h-4 text-[var(--brand)]"></i>
          <span class="name"></span>
        </div>

        <div class="flex flex-wrap sm:flex-nowrap gap-2">
          <button class="buy btn btn-primary px-2 py-1 text-sm sm:px-3 sm:py-2 sm:text-base flex items-center gap-1">
            <i data-lucide="check" class="w-4 h-4"></i> Comprato
          </button>
          <button class="remove btn btn-danger px-2 py-1 text-sm sm:px-3 sm:py-2 sm:text-base flex items-center gap-1">
            <i data-lucide="x" class="w-4 h-4"></i> Eliminato
          </button>
        </div>
      </li>
    </template>

    <script type="module">
      import { supabase, requireAuth } from "./app.js";
      let user = null,
        shoppingId = null;

      document.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        user = await requireAuth();

        const params = new URLSearchParams(window.location.search);
        shoppingId = params.get("id");
        if (!shoppingId) window.location.href = "dashboard.html";

        await loadShoppingInfo();
        await loadProducts();
        await loadHistoryProducts();

        document
          .getElementById("history")
          .addEventListener(
            "click",
            () => (window.location.href = `history.html?id=${shoppingId}`),
          );
        document.getElementById("copy-code").addEventListener("click", () => {
          const code = document.getElementById("shopping-code").textContent;
          navigator.clipboard.writeText(code);
          alert("Codice copiato: " + code);
        });

        document
          .getElementById("add-product")
          .addEventListener("click", addManual);
        document
          .getElementById("add-from-history")
          .addEventListener("click", addFromHistory);
      });

      async function loadShoppingInfo() {
        const { data, error } = await supabase
          .from("shopping_lists")
          .select("title, code")
          .eq("id", shoppingId)
          .single();
        if (error || !data) {
          alert("Errore spesa");
          window.location.href = "dashboard.html";
          return;
        }
        document.getElementById("shopping-title").textContent = data.title;
        document.getElementById("shopping-code").textContent = data.code;
      }

      async function loadProducts() {
        const ul = document.getElementById("products-list");
        ul.innerHTML = "";
        const { data, error } = await supabase
          .from("shopping_products")
          .select("*")
          .eq("shopping_id", shoppingId)
          .order("created_at", { ascending: true });
        if (error) {
          ul.innerHTML = `<li class="muted">Errore</li>`;
          return;
        }
        const tpl = document.getElementById("tpl-product");
        data.forEach((p) => {
          const li = tpl.content.cloneNode(true);
          li.querySelector(".name").textContent = p.name;
          if (p.bought) {
            li.querySelector(".name").classList.add(
              "line-through",
              "text-gray-400",
            );
            li.querySelector(".buy").disabled = true;
          }
          li.querySelector(".buy").addEventListener("click", () =>
            handleProductBought(p.id),
          );
          li.querySelector(".remove").addEventListener("click", () =>
            handleProductRemoved(p.id),
          );
          ul.appendChild(li);
        });
        lucide.createIcons();
      }

      async function loadHistoryProducts() {
        const select = document.getElementById("history-select");
        select.innerHTML = `<option value="">— Seleziona prodotto —</option>`;
        const { data, error } = await supabase
          .from("products_history")
          .select("name, total_count")
          .eq("user_id", user.id)
          .order("total_count", { ascending: false });
        if (error) return;
        data.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = `${p.name} (${p.total_count} volte)`;
          select.appendChild(opt);
        });
      }

      async function addManual() {
        const name = document.getElementById("new-product").value.trim();
        if (!name) return;
        const { error } = await supabase
          .from("shopping_products")
          .insert([{ shopping_id: shoppingId, name, count: 0 }]);
        if (error) alert("Errore: " + error.message);
        else {
          document.getElementById("new-product").value = "";
          loadProducts();
        }
      }

      async function addFromHistory() {
        const name = document.getElementById("history-select").value;
        if (!name) return;
        const { error } = await supabase
          .from("shopping_products")
          .insert([{ shopping_id: shoppingId, name, count: 0 }]);
        if (error) alert("Errore: " + error.message);
        else {
          document.getElementById("history-select").value = "";
          loadProducts();
        }
      }

      async function handleProductBought(productId) {
        const { error } = await supabase.rpc("increment_product_count", {
          pid: productId,
          uid: user.id,
        });
        if (error) alert("Errore: " + error.message);
        else {
          loadProducts();
          loadHistoryProducts();
        }
      }

      async function handleProductRemoved(productId) {
        const { error } = await supabase
          .from("shopping_products")
          .delete()
          .eq("id", productId);
        if (error) alert("Errore: " + error.message);
        else loadProducts();
      }
    </script>
  </body>
</html>
